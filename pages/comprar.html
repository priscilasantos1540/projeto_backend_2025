<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Compra - IF Tickets</title>

    <link rel="stylesheet" href="../styles/home.css">
</head>
<body>

<main class="main">

    <h1 class="title">
        Teste de <span class="contrast">Compra de Ingresso</span>
    </h1>

    <form id="form-compra" class="form">

        <input type="hidden" name="lote_id" value="1">
        <input type="hidden" name="setor_id" value="1">

        <label class="label" for="quantidade">Quantidade de Ingressos</label>
        <input
            type="number"
            id="quantidade"
            name="quantidade"
            class="input"
            value="1"
            min="1"
            required
        >

        <label class="label" for="cupom_codigo">Cupom de desconto (opcional)</label>
        <input
            type="text"
            id="cupom_codigo"
            name="cupom_codigo"
            class="input"
            placeholder="EX: FESTCULT2025"
        >

        <p class="text" id="valor_total"></p>

        <button type="submit" class="button">
            Gerar pagamento (Mercado Pago)
        </button>
    </form>

    <div id="log" class="text" style="margin-top:20px;">
        Aguardando envio...
    </div>

</main>

<script>

    const precoUnitario = 30; // preço do lote (APENAS VISUAL)

    const qtdInput = document.getElementById('quantidade');
    const valorBox = document.getElementById('valor_total');
    const log = document.getElementById('log');

    function atualizarValor() {
        const qtd = Number(qtdInput.value);
        const total = qtd * precoUnitario;
        valorBox.innerText = `Valor total: R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    atualizarValor();
    qtdInput.addEventListener('input', atualizarValor);

   
    document.getElementById('form-compra').addEventListener('submit', async function (e) {
        e.preventDefault();
        log.innerText = 'Processando...';

        const formData = new FormData(this);
        const data = new URLSearchParams(formData);

        try {
            const response = await fetch('/api/criar_pagamento.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: data
            });

            const result = await response.json();

            if (response.ok && result.status === 'ok') {
                log.innerHTML = `
                    <strong>Pedido criado com sucesso!</strong><br><br>
                    <a href="${result.link_pagamento}" target="_blank" class="button">
                        Ir para o pagamento
                    </a>
                `;
            } else {
                log.innerText = result.mensagem || 'Erro ao criar pedido.';
            }

        } catch (err) {
            log.innerText = 'Erro de conexão com o servidor.';
        }
    });
</script>

</body>
</html>
